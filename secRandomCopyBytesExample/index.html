<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Accessing SecRandomCopyBytes Safely With Swift - Thoughts On Development</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://localhost:53367/secRandomCopyBytesExample/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://localhost:53367//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:53367/" class="site-title">Thoughts On Development</a>
      <nav class="site-nav right">
      <a href="http://localhost:53367/about/">About</a>
<a href="http://localhost:53367/tags">Tags</a>
<a href="http://localhost:53367/contact/">Contact</a>

<form class="navbar-search" action="http://localhost:53367//search/index.html"
    onsubmit="return validateForm(this.elements['q'].value);">
    <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input">

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Accessing SecRandomCopyBytes Safely With Swift</h1>
      </div>

      <article class="post-content">
      

<p>Apple has provided a function called <code>SecRandomCopyBytes()</code> inside their Security framework that allows us to create an array of cryptographically secure random bytes. There are other ways to generate random data on iOS and OS X, most notably, <code>arc4random()</code> but this has a problem: Apple&rsquo;s <code>arc4random()</code> isn&rsquo;t secure because <code>arc4random()</code> relies on an underlining stream cipher to achieve secure random data; Apple&rsquo;s implementation uses RC4, which is now considered broken. SecRandomCopyBytes uses CTR_DRB which is still secure.</p>

<p>So now you know a little bit about why we want to use <code>SecRandomCopyBytes()</code>. We will be using Swift to access <code>SecRandomCopyBytes()</code> without using <code>withUnsafeMutablePointer()</code> and <code>unsafeBitCast()</code>. Lets begin by looking at some docs&hellip;</p>

<pre><code>// Obj-C
int SecRandomCopyBytes ( SecRandomRef rnd, size_t count, uint8_t *bytes ); 

// Swift
func SecRandomCopyBytes(_ rnd: SecRandomRef,
                      _ count: Int,
                      _ bytes: UnsafeMutablePointer&lt;UInt8&gt;) -&gt; Int32
</code></pre>

<p><code>rnd</code> is the random number generator (RNG) object to use. <code>kSecRandomDefault</code> is the default RNG.</p>

<p><code>count</code> is the number of bytes to return in the array pointed to by the <code>bytes</code> parameter.</p>

<p><code>bytes</code> is the random bytes generated by the function.</p>

<h2 id="objective-c:13e768278039e1819a22e060a3b8fd1b">Objective-C</h2>

<pre><code>// Obj-C
@import Security;

uint32_t randomNum = 0; 
SecRandomCopyBytes(kSecRandomDefault, 4, (uint8_t*) &amp;randomNum);
</code></pre>

<p>First, we declared an unsigned 32-bit integer and initialized it to 0. Next, we call SecRandomCopyBytes passing 4 as the number of bytes (4 bytes, 32 bits), as well as the address of the <code>randomNum</code> integer we just declared. Awesome.</p>

<h2 id="swift-first-attempt:13e768278039e1819a22e060a3b8fd1b">Swift, First Attempt</h2>

<pre><code>// Swift
import Security

var randomNum: UInt32 = 0
SecRandomCopyBytes(kSecRandomDefault, 4, &amp;randomNum)
</code></pre>

<p>This won&rsquo;t work. A compiler error is generated because UInt32 is not the same as UInt8. Yay for strongly typed languages! (Seriously though, I think they&rsquo;re great.)</p>

<h2 id="swift-playing-it-safe:13e768278039e1819a22e060a3b8fd1b">Swift, Playing it Safe</h2>

<pre><code>// Swift 
import Security

let bytesCount = 4 // number of bytes
var randomNum: UInt32 = 0 // variable for random unsigned 32 bit integer
var randomBytes = [UInt8](count: bytesCount, repeatedValue: 0) // array to hold randoms bytes

SecRandomCopyBytes(kSecRandomDefault, bytesCount, &amp;randomBytes)

NSData(bytes: randomBytes, length: bytesCount).getBytes(&amp;randomNum, length: bytesCount)

print(randomNum)
</code></pre>

<p>So what&rsquo;s going on here? First, we initialize a variable for the number of bytes we want to use (4 bytes, 32 bits). Next, we initialize a variable for the random number we&rsquo;re trying to generate and we initialize an array to hold the random bytes. Then, we can call <code>SecRandomCopyBytes()</code> passing in the default RNG, the number of bytes we want to generate, and the address to the array of bytes. Finally, we create a NSData object based on the array of bytes and we get the bytes ( <code>.getBytes()</code> ) by passing in the address where the bytes will be going (which is an unsigned 32 bit int in our case) and the number of bytes. <code>randomNum</code> now has 32 bits of random data. Awesome! (The print is just so you can see the number.)</p>

<h2 id="wrapping-up:13e768278039e1819a22e060a3b8fd1b">Wrapping Up</h2>

<p>I hope you learn something here, I know I have while researching iOS security. Swift has also become my favorite language and really love writing code in it.  I can&rsquo;t wait to see how Swift develops as an open source language.  Thanks for reading.</p>

<p>Follow me on twitter for more!</p>

      </article>
    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://localhost:53367/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/jamcar23"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://localhost:53367/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>



<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':53367/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

